## akkaflow使用示例
### 一、任务说明

现在准备一个任务，把一份文本数据导入到指定库表中。  

* 1、创建一个数据库
* 2、准备一份数据文本
* 3、导入到该表中

**注意：** 确保akkflow系统已经启动
### 二、操作步骤

#### 1、定义数据源
修改`config/db_link.xml`文件，增加一个数据源 local_mysql，后续的操作基于这个数据库上进行操作
```xml
<db-links>
	<link name="local_mysql" type="MYSQL" jdbc-url="jdbc:mysql://localhost:3306/wf" username="root" password="root"/>
	<link name="local_orcl" type="ORACLE" jdbc-url="jdbc:oracle:thin:@//xxx.xxx.xxx.xxx:xxx/sid" username="xxxx" password="xxxx"/>
	<link name="local_hive" type="HIVE" jdbc-url="jdbc:hive2://quickstart.cloudera:10000/" username="hdfs" password="hdfs"/>
</db-links> 
```


#### 2、准备工作流定义文件
准备一个定义工作流的xml文件，把以上的步骤转换为任务节点，产出了 load_data.xml
```xml
<work-flow name="load_data" creator="Kent" mail-receivers="15018735011@163.com" desc="测试a">
    <!-- 调度配置 -->
    <coordinator>
        <!-- 每天1点执行-->
        <depend-list cron="0 1 * * *"></depend-list>
        <param-list>
            <param name="stadate" value="${time.today|yyyy-MM-dd|-1 day}"/>
        </param-list>
    </coordinator>  
    <!-- 节点列表 -->
    <start name="start" to="create" />
  
    <action name="create" retry-times="0" interval="10" desc = "创建表">
        <sql db-link="local_mysql">
        create table test(col1 int, col2 int)
        </sql>
        <ok to="script"/>  
    </action>  
    <action name="script" desc = "生成数据文件">
        <script>
            <code><![CDATA[
            rm -f /tmp/test_data.txt
            for i in `seq 0 20`;do
                printf "$i\t$i\n" >> /tmp/test_data.txt
            done
            ]]></code>
        </script>
        <ok to="transfer"/>
    </action>

    <action name="transfer" desc = "数据文件导入到目标表中">
        <transfer>
            <source type="FILE">/tmp/test_data.txt</source>
            <target type="DB" db-link="local_mysql" table="test"></target>
        </transfer>
        <ok to="end"/>
     </action>

  <end name="end"/>
</work-flow>
```
#### 3、提交工作流
把load_data.xml提交到akkalfow调度系统上
```shell
kentdeMacBook-Pro:sbin kent$ akka workflow -add /tmp/load_data.xml
{"result":"success","msg":"成功添加工作流load_data","data":null}
```
#### 4、查看工作流信息
查看刚刚提交的工作流load_data的信息
```shell
kentdeMacBook-Pro:sbin kent$ akka workflow -info load_data
=================================工作流信息=====================================
工 作 流: load_data
创 建 者: Kent
目    录: /tmp
参    数: []
告警级别: 失败告警
收件人员: ["15018735011@163.com"]
实例上限: 1
创建时间: 2018-07-23 19:42:44
文件目录：/tmp/load_data.xml
描    述: 测试a
=================================调度配置=====================================
是否可用: 可用
调度参数: [{"stadate": "${time.today|yyyy-MM-dd|-1 day}"}]
时间触发: 0 1 * * *  (2018-07-24 01:00:00)
前置依赖:
后置触发:
生效时段: 1990-12-29 00:00:00 - 2090-12-29 00:00:00
=================================节点运行信息=====================================
+--------------+--------------+-----------------------------------+
| 节点名称     | 节点类型     | 描述                              |
+--------------+--------------+-----------------------------------+
| start        | StartNode    |                                   |
| create       | SqlNode      | 创建表                            |
| script       | ScriptNode   | 生成数据文件                      |
| transfer     | TransferNode | 数据文件导入到目标表中            |
| end          | EndNode      |                                   |
+--------------+--------------+-----------------------------------+
```

##### 5、触发运行工作流
触发指定工作流后，会产生一个工作流实例，每个实例都有一个唯一的实例ID
```shell
kentdeMacBook-Pro:sbin kent$ akka workflow -trigger load_data
{"result":"success","msg":"成功触发工作流[load_data]执行","data":null}
```

##### 6、查看首页实例情况
```shell
kentdeMacBook-Pro:sbin kent$ akka front
=================================近七天实例执行统计=====================================
+--------+------------+------------+------------+------------+------------+------------+------------+------------+
| status | 2018-07-23 | 2018-07-22 | 2018-07-21 | 2018-07-20 | 2018-07-19 | 2018-07-18 | 2018-07-17 | 2018-07-16 |
+--------+------------+------------+------------+------------+------------+------------+------------+------------+
| 成功   |        659 |         88 |          0 |          0 |          0 |          0 |          0 |          0 |
| 杀死   |          1 |          0 |          0 |          0 |          0 |          0 |          0 |          0 |
+--------+------------+------------+------------+------------+------------+------------+------------+------------+
=================================运行中工作流实例=====================================

=================================运行结束工作流实例=====================================
+----------+-----------------+-----------+--------------+---------------------+---------------------+--------------+
| 实例ID   | 工作流名称      | 创建者    | 运行状态     | 开始时间            | 结束时间            | 运行时长     |
+----------+-----------------+-----------+--------------+---------------------+---------------------+--------------+
| 6a576eb8 | load_data       | Kent      | 成功         | 2018-07-23 20:15:20 | 2018-07-23 20:15:21 |            1 |
| 4eccec71 | test            | Kent      | 成功         | 2018-07-23 20:14:00 | 2018-07-23 20:14:00 |            0 |
| f8aebf0c | test            | Kent      | 成功         | 2018-07-23 20:13:00 | 2018-07-23 20:13:00 |            0 |
| 0225117a | test            | Kent      | 成功         | 2018-07-23 20:12:00 | 2018-07-23 20:12:00 |            0 |
| 10e67355 | test            | Kent      | 成功         | 2018-07-23 20:10:00 | 2018-07-23 20:10:00 |            0 |
| 95e602bf | test            | Kent      | 成功         | 2018-07-23 20:09:00 | 2018-07-23 20:09:00 |            0 |
| 41de9bcb | test            | Kent      | 成功         | 2018-07-23 20:08:00 | 2018-07-23 20:08:00 |            0 |
| 15316d0a | test            | Kent      | 成功         | 2018-07-23 20:07:00 | 2018-07-23 20:07:00 |            0 |
| 350b2bc7 | test            | Kent      | 成功         | 2018-07-23 20:06:00 | 2018-07-23 20:06:00 |            0 |
| 862b1f21 | test            | Kent      | 成功         |  2018-07-23 19:55:00 | 2018-07-23 19:55:00 |            0 |
+----------+-----------------+-----------+--------------+---------------------+---------------------+--------------+
```
#### 7、查看实例执行情况
可以看到，load_data工作流生成了ID为6a576eb8的实例，查看该实例执行的情况，各个节点的运行情况
```shell
kentdeMacBook-Pro:sbin kent$ akka instance -info 6a576eb8
=================================工作流实例信息=====================================
实 例 ID: 6a576eb8
工 作 流: load_data
运行状态: 成功
开始时间: 2018-07-23 20:15:20
运行时长: 1
目    录: /tmp
参    数: stadate:2018-07-22
告警级别: 失败告警
收件人员: ["15018735011@163.com"]
实例上限: 1
描    述: 测试a
=================================节点运行信息=====================================
+--------------+--------------+--------+---------------------+---------------------+--------------------+-----------------------------------+
| 节点名称     | 节点类型     | 状态   | 运行时长（s）       | 开始时间            | 执行信息           | 描述                              |
+--------------+--------------+--------+---------------------+---------------------+--------------------+-----------------------------------+
| start        | StartNode    | 成功   |                   0 | 2018-07-23 20:15:20 |                    |                                   |
| create       | SqlNode      | 成功   |                   0 | 2018-07-23 20:15:20 | 节点执行成功       | 创建表                            |
| script       | ScriptNode   | 成功   |                   0 | 2018-07-23 20:15:20 | 节点执行成功       | 生成数据文件                      |
| transfer     | TransferNode | 成功   |                   0 | 2018-07-23 20:15:21 | 节点执行成功       | 数据文件导入到目标表中            |
| end          | EndNode      | 成功   |                   0 | 2018-07-23 20:15:21 |                    |                                   |
+--------------+--------------+--------+---------------------+---------------------+--------------------+-----------------------------------+
```
####8、查看实例执行日志
查看刚刚运行成功的实例，产生了什么日志，若实例执行失败，可以查看日志来找到失败原因。
```shell
kentdeMacBook-Pro:sbin kent$ akka instance -info 6a576eb8 --log
=================================实例日志信息=====================================
日志信息	内容
[INFO] [2018-07-23 20:15:20.178]	开始生成并执行工作流实例：load_data:6a576eb8
[INFO] [2018-07-23 20:15:20.180]	工作流实例:[load_data:6a576eb8]开始启动
[INFO] [2018-07-23 20:15:20.190]	执行节点：start， 类型：StartNodeInstance
[INFO] [2018-07-23 20:15:20.298]	执行节点：create， 类型：SqlNodeInstance
[INFO] [2018-07-23 20:15:20.301]	节点[create]分配给Worker[127.0.0.1:2852]
[INFO] [2018-07-23 20:15:20.319][create]	执行成功：节点执行成功
[INFO] [2018-07-23 20:15:20.408]	执行节点：script， 类型：ScriptNodeInstance
[INFO] [2018-07-23 20:15:20.409]	节点[script]分配给Worker[127.0.0.1:2851]
[INFO] [2018-07-23 20:15:20.448][script]	执行成功：节点执行成功
[INFO] [2018-07-23 20:15:20.507]	执行节点：transfer， 类型：TransferNodeInstance
[INFO] [2018-07-23 20:15:20.508]	节点[transfer]分配给Worker[127.0.0.1:2853]
[INFO] [2018-07-23 20:15:20.525][transfer]	执行建表语句: create table if not exists test(col_0 varchar(256),col_1 varchar(256))
[INFO] [2018-07-23 20:15:20.562][transfer]	成功插入63
[INFO] [2018-07-23 20:15:20.566][transfer]	共插入63条记录
[INFO] [2018-07-23 20:15:20.568][transfer]	执行成功：节点执行成功
[INFO] [2018-07-23 20:15:20.606]	执行节点：end， 类型：EndNodeInstance
[INFO] [2018-07-23 20:15:20.614]	工作流实例：6a576eb8执行完毕，执行状态为：成功
```

### 最后
可以直接输入akka命令了解所有的命令集，整套命令集相对来说会比较容易理解和操作，能满足日常的操作与使用。


